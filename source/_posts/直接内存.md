---
title: 直接内存
date: 2020-11-09 13:18:50
tags: java基础
categories: 编程
---
# 概述

1. 不是虚拟机运行时数据区的一部分，也不是《Java虚拟机规范》中定义的内存区域。
2. 直接内存是在Java堆外的、直接向系统申请的内存区间。
3. 来源于NIO，通过存在堆中的DirectByteBuffer操作Native内存
4. 通常，访问直接内存的速度会优于Java堆。即读写性能高。因此出于性能考虑，读写频繁的场合可能会考虑使用直接内存，Java的NIO库允许Java程序使用直接内存，用于数据缓冲区
![图1](https://github.com/PayneZh/MarkDownPhotos/raw/master/res/java%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98/%E9%9D%9E%E7%9B%B4%E6%8E%A5%E7%BC%93%E5%86%B2%E5%8C%BA.jpg)
读写文件，需要与磁盘交互，需要由用户态切换到内核态。在内核态时，需要内存如上图的操作，使用IO，见上图，这里需要两份内存存储重复数据，效率低。

![图2](https://github.com/PayneZh/MarkDownPhotos/raw/master/res/java%E7%9B%B4%E6%8E%A5%E5%86%85%E5%AD%98/%E7%9B%B4%E6%8E%A5%E7%BC%93%E5%86%B2%E5%8C%BA.jpg)
使用NIO时，如上图。操作系统划出的直接缓存区可以被java代码直接访问，只有一份。NIO适合对大文件的读写操作。
5. 也可能导致OutOfMemoryError异常
6. 由于直接内存在Java堆外，因此它的大小不会直接受限于-Xmx指定的最大堆大小，但是系统内存是有限的，Java堆和直接内存的总和依然受限于操作系统能给出的最大内存。
7. 缺点：分配回收成本高，不受JVM内存回收管理
8. 直接内存大小可以通过MaxDirectMemorySize设置
9. 如果不指定，默认与堆最大值-Xmx参数值一致